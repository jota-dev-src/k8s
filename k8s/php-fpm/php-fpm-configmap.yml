apiVersion: v1
kind: ConfigMap
metadata:
  namespace: svc
  name: php-conf
  labels:
    app: php
    tier: backend
data:
  php-fpm.conf: |-
    [global]
    daemonize = no
    listen = 9000
    pid = run/php-fpm.pid
    
    process.priority = -19
    rlimit_files = 131072
    rlimit_core = unlimited
    security.limit_extensions = .php
    clear_env = yes
    
    ; https://github.com/docker-library/php/pull/725#issuecomment-443540114
    log_limit = 8192
    access.log = /proc/self/fd/2
    error_log = /proc/self/fd/2
    
    catch_workers_output = yes
    decorate_workers_output = no
    
    env[PATH] = /usr/local/bin
    
    php_flag[display_errors] = off
    
    include=etc/php-fpm.d/*.conf
immutable: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: svc
  name: php-pools
  labels:
    app: php
    tier: backend
data:
  www.conf: |-
    [www]
    user = www-data
    group = www-data

    clear_env = no

    pm = static
    pm.max_children = 10
    pm.max_requests = 500
    
    ;env[HOSTNAME] = $HOSTNAME
    ;env[PATH] = /usr/local/bin:/usr/bin:/bin
    ;env[TMP] = /tmp
    ;env[TMPDIR] = /tmp
    ;env[TEMP] = /tmp
    
    ;php_admin_value[error_log] = /var/log/fpm-php.www.log
    ;php_admin_flag[log_errors] = on
    ;php_admin_value[memory_limit] = 32M
immutable: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: svc
  name: php-modules
  labels:
    app: php
    tier: backend
data:
  00-php.ini: |-
    [PHP]
    max_execution_time = 30
    memory_limit = 256M
  10-opcache.ini: |-
    zend_extension=opcache.so

    opcache.enable = 1
    opcache.memory_consumption = 128
    opcache.max_accelerated_files = 5000
    opcache.revalidate_freq = 0
    opcache.validate_timestamps = 0
  20-apcu.ini: |-
    extension = apcu.so

    [apcu]
    apc.enabled = 1
  20-gd.ini: |-
    extension = gd.so
  20-igbinary.ini: |-
    extension = igbinary.so

    igbinary.compact_strings = On
  20-intl.ini: |-
    extension = sodium.so
  20-pdo_mysql.ini: |-
    extension = pdo_mysql.so
  20-redis.ini: |-
    extension = redis.so
  25-apcu_bc.ini: |-
    '# extension = apc.so'
immutable: false
